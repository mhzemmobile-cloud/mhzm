<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø¹Ù‚ÙˆØ¯ Ù…Ø­Ø²Ù… | Mhzm Contracts</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- BrosTec Style --- */
        :root { --primary: #0056b3; --surface: #1e1e1e; --bg: #121212; --text: #e0e0e0; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: var(--surface); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        .header { background: #fff; padding: 15px; text-align: center; border-bottom: 4px solid var(--primary); }
        .header img { height: 70px; display: block; margin: 0 auto; }
        .section { display: none; padding: 30px; }
        .section.active { display: block; }
        input { width: 100%; padding: 12px; background: #252525; border: 1px solid #333; border-radius: 8px; color: #fff; margin-bottom: 10px; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1.1rem; }
        .contract-box { background: #fff; color: #333; padding: 30px; border-radius: 8px; line-height: 1.6; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f4f4f4; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .stamp-box { width: 140px; height: 140px; border: 3px solid var(--primary); border-radius: 50%; margin: 20px auto; color: var(--primary); display: flex; align-items: center; justify-content: center; flex-direction: column; transform: rotate(-15deg); opacity: 0.8; font-weight: 900; }
        @media print { body { background: #fff; } .container { box-shadow: none; border: none; } .no-print { display: none; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="https://mhzm.sa/wp-content/webp-express/webp-images/uploads/2024/05/%D9%84%D9%88%D8%AC%D9%88.png.webp" alt="Mhzm">
            <h3 class="no-print" style="color:var(--primary); margin-top:5px;">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h3>
        </div>

        <div id="adminView" class="section">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input type="text" id="cName">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹)</label><input type="tel" id="cPhone" placeholder="05xxxxxxxx">
            <label>Ø§Ù„Ø¬Ù‡Ø§Ø²</label><input type="text" id="cDevice">
            <label>IMEI</label><input type="text" id="cIMEI">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><input type="number" id="cTotal"></div>
                <div style="flex:1"><label>Ø§Ù„Ù‚Ø³Ø·</label><input type="number" id="cMonthly"></div>
            </div>
            
            <div style="background:rgba(255,255,255,0.05); padding:10px; margin-top:10px; border-radius:5px;">
                <small style="color:#888;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</small>
                <input type="text" id="botToken" placeholder="Bot Token">
                <input type="text" id="chatId" placeholder="Chat ID">
            </div>

            <button onclick="createLink()" class="btn">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯</button>
        </div>

        <div id="authView" class="section">
            <div style="text-align: center; padding: 40px 0;">
                <h3>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h3>
                <p style="color:#aaa;">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯</p>
                <input type="tel" id="authPhone" placeholder="05xxxxxxxx" style="text-align: center; font-size: 1.2rem;">
                <button onclick="checkPhone()" class="btn">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>

        <div id="contractView" class="section">
            <div class="contract-box">
                <h2 style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px;">Ø§ØªÙØ§Ù‚ÙŠØ© ØªÙ‚Ø³ÙŠØ·</h2>
                <div class="data-grid">
                    <div>Ø§Ù„Ø¹Ù…ÙŠÙ„: <b id="vName"></b></div>
                    <div>Ø§Ù„Ø¬ÙˆØ§Ù„: <b id="vPhone"></b></div>
                    <div>Ø§Ù„Ø¬Ù‡Ø§Ø²: <b id="vDevice"></b></div>
                    <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="vTotal"></b> Ø±ÙŠØ§Ù„</div>
                </div>
                
                <p><b>Ø§Ù„Ø´Ø±ÙˆØ·:</b> ÙŠÙ‚Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø­Ø§Ù„Ø© Ø³Ù„ÙŠÙ…Ø©ØŒ ÙˆÙŠÙ„ØªØ²Ù… Ø¨Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (<span id="vMonthly"></span> Ø±ÙŠØ§Ù„ Ø´Ù‡Ø±ÙŠØ§Ù‹). Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù„Ùƒ Ù„Ù„Ù…ØªØ¬Ø± Ø­ØªÙ‰ Ø³Ø¯Ø§Ø¯ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº. ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ù‚Ø³Ø·ÙŠÙ† ÙŠØ­Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ§Ù…Ù„Ø§Ù‹.</p>

                <div id="sigArea" class="no-print" style="margin-top:20px; text-align:center; background:#f9f9f9; padding:20px; border:1px dashed #ccc;">
                    <label style="color:#333;">Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ:</label>
                    <input type="text" id="sigName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." style="background:#fff; color:#000; text-align:center; border:1px solid #ccc;">
                    <button onclick="signContract()" class="btn">ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯</button>
                </div>

                <div id="stampArea" style="display:none; text-align:center;">
                    <div class="stamp-box">
                        <span>MHZM</span>
                        <small>ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</small>
                    </div>
                    <p>ÙˆÙ‚Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø©: <b id="finalSig"></b></p>
                </div>
            </div>
            
            <button id="printBtn" onclick="window.print()" class="btn no-print" style="background:#333; margin-top:10px; display:none;">Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
        </div>
        
        <div id="successView" class="section" style="text-align:center;">
            <h1 style="color:#28a745; font-size:4rem;">âœ“</h1>
            <h3>ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­</h3>
        </div>
    </div>

    <script>
        // --- Global Functions (Ù…Ø¶Ù…ÙˆÙ†Ø© Ø§Ù„Ø¹Ù…Ù„) ---

        // 1. Helper to handle URL Data
        function encode(data) { return btoa(unescape(encodeURIComponent(JSON.stringify(data)))); }
        function decode(str) { try { return JSON.parse(decodeURIComponent(escape(atob(str)))); } catch(e){ return null; } }

        // 2. Initialize Logic
        const params = new URLSearchParams(window.location.search);
        const cParam = params.get('c');
        const sParam = params.get('s');

        // Load saved Telegram settings
        if(localStorage.getItem('tk')) document.getElementById('botToken').value = localStorage.getItem('tk');
        if(localStorage.getItem('id')) document.getElementById('chatId').value = localStorage.getItem('id');

        // Router
        if (cParam && sParam) {
            // Admin viewing signed contract
            showContract(cParam, sParam);
        } else if (cParam) {
            // Client login
            document.getElementById('authView').classList.add('active');
        } else {
            // Dashboard
            document.getElementById('adminView').classList.add('active');
        }

        // --- Action 1: Create Link ---
        function createLink() {
            const tk = document.getElementById('botToken').value;
            const id = document.getElementById('chatId').value;
            localStorage.setItem('tk', tk);
            localStorage.setItem('id', id);

            const data = {
                n: document.getElementById('cName').value,
                p: document.getElementById('cPhone').value,
                d: document.getElementById('cDevice').value,
                i: document.getElementById('cIMEI').value,
                t: document.getElementById('cTotal').value,
                m: document.getElementById('cMonthly').value,
                tk: tk, id: id
            };

            const link = window.location.origin + window.location.pathname + "?c=" + encode(data);
            navigator.clipboard.writeText(link);
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„:\n" + link);
        }

        // --- Action 2: Client Verify (The Fix) ---
        function checkPhone() {
            const inputPhone = document.getElementById('authPhone').value.trim(); // Remove spaces
            const data = decode(cParam);

            if (!data) {
                alert("Ø®Ø·Ø£: Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù‚Ø¯ ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­.");
                return;
            }

            // Check match (Last 5 digits to be safe)
            if (inputPhone.length >= 5 && data.p.includes(inputPhone.slice(-5))) {
                document.getElementById('authView').classList.remove('active');
                showContract(cParam, null);
            } else {
                alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯.\nØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€: " + data.p.slice(-4));
            }
        }

        // --- Action 3: Show Contract ---
        function showContract(cVal, sVal) {
            const d = decode(cVal);
            document.getElementById('contractView').classList.add('active');
            
            document.getElementById('vName').innerText = d.n;
            document.getElementById('vPhone').innerText = d.p;
            document.getElementById('vDevice').innerText = d.d + " (" + d.i + ")";
            document.getElementById('vTotal').innerText = d.t;
            document.getElementById('vMonthly').innerText = d.m;

            if (sVal) {
                // Already Signed
                const s = decode(sVal);
                document.getElementById('sigArea').style.display = 'none';
                document.getElementById('stampArea').style.display = 'block';
                document.getElementById('finalSig').innerText = s.n;
                document.getElementById('printBtn').style.display = 'block';
            }
        }

        // --- Action 4: Sign & Send Telegram ---
        function signContract() {
            const name = document.getElementById('sigName').value;
            if (name.length < 3) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹"); return; }

            const d = decode(cParam);
            const sigData = { n: name, date: Date.now() };
            const finalLink = window.location.origin + window.location.pathname + "?c=" + cParam + "&s=" + encode(sigData);

            // Send to Telegram
            const msg = `âœ… *Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ (Ù…Ø­Ø²Ù…)*\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${d.n}\nØ§Ù„Ø¬Ù‡Ø§Ø²: ${d.d}\nğŸ”— [Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙØªØ­ Ø§Ù„Ø¹Ù‚Ø¯](${finalLink})`;
            
            if (d.tk && d.id) {
                fetch(`https://api.telegram.org/bot${d.tk}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: d.id, text: msg, parse_mode: 'Markdown' })
                }).then(() => {
                    document.getElementById('contractView').classList.remove('active');
                    document.getElementById('successView').classList.add('active');
                }).catch(() => {
                    alert("ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙƒÙ† ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Øª).");
                    // Still show success locally
                    document.getElementById('contractView').classList.remove('active');
                    document.getElementById('successView').classList.add('active');
                });
            } else {
                alert("ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.");
            }
        }
    </script>
</body>
</html>
